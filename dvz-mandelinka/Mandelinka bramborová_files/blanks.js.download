H5P.Blanks=(function($,Question){var STATE_ONGOING='ongoing';var STATE_CHECKING='checking';var STATE_SHOWING_SOLUTION='showing-solution';var STATE_FINISHED='finished';const XAPI_ALTERNATIVE_EXTENSION='https://h5p.org/x-api/alternatives';const XAPI_CASE_SENSITIVITY='https://h5p.org/x-api/case-sensitivity';const XAPI_REPORTING_VERSION_EXTENSION='https://h5p.org/x-api/h5p-reporting-version';function Blanks(params,id,contentData){var self=this;Question.call(self,'blanks');this.contentId=id;this.contentData=contentData;this.params=$.extend(true,{},{text:"Fill in",questions:["Oslo is the capital of *Norway*."],overallFeedback:[],userAnswers:[],showSolutions:"Show solution",tryAgain:"Try again",checkAnswer:"Check",changeAnswer:"Change answer",notFilledOut:"Please fill in all blanks to view solution",answerIsCorrect:"':ans' is correct",answerIsWrong:"':ans' is wrong",answeredCorrectly:"Answered correctly",answeredIncorrectly:"Answered incorrectly",solutionLabel:"Correct answer:",inputLabel:"Blank input @num of @total",inputHasTipLabel:"Tip available",tipLabel:"Tip",scoreBarLabel:'You got :num out of :total points',behaviour:{enableRetry:true,enableSolutionsButton:true,enableCheckButton:true,caseSensitive:true,showSolutionsRequiresInput:true,autoCheck:false,separateLines:false},a11yCheck:'Check the answers. The responses will be marked as correct, incorrect, or unanswered.',a11yShowSolution:'Show the solution. The task will be marked with its correct solution.',a11yRetry:'Retry the task. Reset all responses and start the task over again.',a11yHeader:'Checking mode',},params);for(var i=this.params.questions.length-1;i>=0;i--){if(!this.params.questions[i]){this.params.questions.splice(i,1);}}
this.contentData=contentData;if(this.contentData!==undefined&&this.contentData.previousState!==undefined){this.previousState=this.contentData.previousState;}
this.clozes=[];this.shiftPressed=false;H5P.$body.keydown(function(event){if(event.keyCode===16){self.shiftPressed=true;}}).keyup(function(event){if(event.keyCode===16){self.shiftPressed=false;}});}
Blanks.prototype=Object.create(Question.prototype);Blanks.prototype.constructor=Blanks;Blanks.prototype.registerDomElements=function(){var self=this;var media=self.params.media;if(media&&media.type&&media.type.library){media=media.type;var type=media.library.split(' ')[0];if(type==='H5P.Image'){if(media.params.file){self.setImage(media.params.file.path,{disableImageZooming:self.params.media.disableImageZooming||false,alt:media.params.alt,title:media.params.title});}}
else if(type==='H5P.Video'){if(media.params.sources){self.setVideo(media);}}}
const labelId='h5p-blanks-instructions-'+Blanks.idCounter;self.setIntroduction('<div id="'+labelId+'">'+self.params.text+'</div>');self.setContent(self.createQuestions(labelId),{'class':self.params.behaviour.separateLines?'h5p-separate-lines':''});self.registerButtons();self.setH5PUserState();};Blanks.prototype.registerButtons=function(){var self=this;var $content=$('[data-content-id="'+self.contentId+'"].h5p-content');var $containerParents=$content.parents('.h5p-container');var $container;if($containerParents.length!==0){$container=$containerParents.last();}
else if($content.length!==0){$container=$content;}
else{$container=$(document.body);}
if(!self.params.behaviour.autoCheck&&this.params.behaviour.enableCheckButton){self.addButton('check-answer',self.params.checkAnswer,function(){self.a11yHeader.innerHTML=self.params.a11yHeader;self.a11yHeader.focus();self.toggleButtonVisibility(STATE_CHECKING);self.markResults();self.showEvaluation();self.triggerAnswered();},true,{'aria-label':self.params.a11yCheck,},{confirmationDialog:{enable:self.params.behaviour.confirmCheckDialog,l10n:self.params.confirmCheck,instance:self,$parentElement:$container}});}
self.addButton('show-solution',self.params.showSolutions,function(){self.showCorrectAnswers(false);},self.params.behaviour.enableSolutionsButton,{'aria-label':self.params.a11yShowSolution,});if(self.params.behaviour.enableRetry===true){self.addButton('try-again',self.params.tryAgain,function(){self.a11yHeader.innerHTML='';self.resetTask();self.$questions.filter(':first').find('input:first').focus();},true,{'aria-label':self.params.a11yRetry,},{confirmationDialog:{enable:self.params.behaviour.confirmRetryDialog,l10n:self.params.confirmRetry,instance:self,$parentElement:$container}});}
self.toggleButtonVisibility(STATE_ONGOING);};Blanks.prototype.handleBlanks=function(question,handler){var clozeEnd,clozeStart=question.indexOf('*');var self=this;while(clozeStart!==-1&&clozeEnd!==-1){clozeStart++;clozeEnd=question.indexOf('*',clozeStart);if(clozeEnd===-1){continue;}
var clozeContent=question.substring(clozeStart,clozeEnd);var replacer='';if(clozeContent.length){replacer=handler(self.parseSolution(clozeContent));clozeEnd++;}
else{clozeStart+=1;}
question=question.slice(0,clozeStart-1)+replacer+question.slice(clozeEnd);clozeEnd-=clozeEnd-clozeStart-replacer.length;clozeStart=question.indexOf('*',clozeEnd);}
return question;};Blanks.prototype.createQuestions=function(labelId){var self=this;var html='';var clozeNumber=0;for(var i=0;i<self.params.questions.length;i++){var question=self.params.questions[i];question=self.handleBlanks(question,function(solution){clozeNumber+=1;var defaultUserAnswer=(self.params.userAnswers.length>self.clozes.length?self.params.userAnswers[self.clozes.length]:null);var cloze=new Blanks.Cloze(solution,self.params.behaviour,defaultUserAnswer,{answeredCorrectly:self.params.answeredCorrectly,answeredIncorrectly:self.params.answeredIncorrectly,solutionLabel:self.params.solutionLabel,inputLabel:self.params.inputLabel,inputHasTipLabel:self.params.inputHasTipLabel,tipLabel:self.params.tipLabel});self.clozes.push(cloze);return cloze;});html+='<div role="group" aria-labelledby="'+labelId+'">'+question+'</div>';}
self.hasClozes=clozeNumber>0;this.$questions=$(html);self.a11yHeader=document.createElement('div');self.a11yHeader.classList.add('hidden-but-read');self.a11yHeader.tabIndex=-1;self.$questions[0].insertBefore(self.a11yHeader,this.$questions[0].childNodes[0]||null);this.$questions.find('input').each(function(i){var afterCheck;if(self.params.behaviour.autoCheck){afterCheck=function(){var answer=$("<div>").text(this.getUserAnswer()).html();self.read((this.correct()?self.params.answerIsCorrect:self.params.answerIsWrong).replace(':ans',answer));if(self.done||self.allBlanksFilledOut()){self.toggleButtonVisibility(STATE_CHECKING);self.showEvaluation();self.triggerAnswered();self.done=true;}};}
self.clozes[i].setInput($(this),afterCheck,function(){self.toggleButtonVisibility(STATE_ONGOING);if(!self.params.behaviour.autoCheck){self.hideEvaluation();}},i,self.clozes.length);}).keydown(function(event){var $this=$(this);self.autoGrowTextField($this);var $inputs,isLastInput;var enterPressed=(event.keyCode===13);var tabPressedAutoCheck=(event.keyCode===9&&self.params.behaviour.autoCheck);if(enterPressed||tabPressedAutoCheck){$inputs=self.$questions.find('.h5p-input-wrapper:not(.h5p-correct) .h5p-text-input');isLastInput=$this.is($inputs[$inputs.length-1]);}
if((tabPressedAutoCheck&&isLastInput&&!self.shiftPressed)||(enterPressed&&isLastInput)){setTimeout(function(){self.focusButton();},10);}
if(enterPressed){if(isLastInput){$this.trigger('blur');}
else{$inputs.eq($inputs.index($this)+1).focus();}
return false;}}).on('change',function(){self.answered=true;self.triggerXAPI('interacted');});self.on('resize',function(){self.resetGrowTextField();});return this.$questions;};Blanks.prototype.autoGrowTextField=function($input){if(this.params.behaviour.separateLines){return;}
var self=this;var fontSize=parseInt($input.css('font-size'),10);var minEm=3;var minPx=fontSize*minEm;var rightPadEm=3.25;var rightPadPx=fontSize*rightPadEm;var static_min_pad=0.5*fontSize;setTimeout(function(){var tmp=$('<div>',{'text':$input.val()});tmp.css({'position':'absolute','white-space':'nowrap','font-size':$input.css('font-size'),'font-family':$input.css('font-family'),'padding':$input.css('padding'),'width':'initial'});$input.parent().append(tmp);var width=tmp.width();var parentWidth=self.$questions.width();tmp.remove();if(width<=minPx){$input.width(minPx+static_min_pad);}
else if(width+rightPadPx>=parentWidth){$input.width(parentWidth-rightPadPx);}
else{$input.width(width+static_min_pad);}},1);};Blanks.prototype.resetGrowTextField=function(){var self=this;this.$questions.find('input').each(function(){self.autoGrowTextField($(this));});};Blanks.prototype.toggleButtonVisibility=function(state){var allCorrect=(this.getScore()===this.getMaxScore());if(this.params.behaviour.autoCheck&&allCorrect){state=STATE_FINISHED;}
if(this.params.behaviour.enableSolutionsButton){if(state===STATE_CHECKING&&!allCorrect){this.showButton('show-solution');}
else{this.hideButton('show-solution');}}
if(this.params.behaviour.enableRetry){if((state===STATE_CHECKING&&!allCorrect)||state===STATE_SHOWING_SOLUTION){this.showButton('try-again');}
else{this.hideButton('try-again');}}
if(state===STATE_ONGOING){this.showButton('check-answer');}
else{this.hideButton('check-answer');}
this.trigger('resize');};Blanks.prototype.allowSolution=function(){if(this.params.behaviour.showSolutionsRequiresInput===true){if(!this.allBlanksFilledOut()){this.updateFeedbackContent(this.params.notFilledOut);this.read(this.params.notFilledOut);return false;}}
return true;};Blanks.prototype.allBlanksFilledOut=function(){return!this.clozes.some(function(cloze){return!cloze.filledOut();});};Blanks.prototype.markResults=function(){var self=this;for(var i=0;i<self.clozes.length;i++){self.clozes[i].checkAnswer();if(!self.params.behaviour.enableRetry){self.clozes[i].disableInput();}}
this.trigger('resize');};Blanks.prototype.removeMarkedResults=function(){this.$questions.find('.h5p-input-wrapper').removeClass('h5p-correct h5p-wrong');this.$questions.find('.h5p-input-wrapper > input').attr('disabled',false);this.trigger('resize');};Blanks.prototype.showCorrectAnswers=function(alwaysShowSolution){if(!alwaysShowSolution&&!this.allowSolution()){return;}
this.toggleButtonVisibility(STATE_SHOWING_SOLUTION);this.hideSolutions();for(var i=0;i<this.clozes.length;i++){this.clozes[i].showSolution();}
this.trigger('resize');};Blanks.prototype.toggleAllInputs=function(enabled){for(var i=0;i<this.clozes.length;i++){this.clozes[i].toggleInput(enabled);}};Blanks.prototype.showSolutions=function(){this.params.behaviour.enableSolutionsButton=true;this.toggleButtonVisibility(STATE_FINISHED);this.markResults();this.showEvaluation();this.showCorrectAnswers(true);this.toggleAllInputs(false);this.hideButtons();};Blanks.prototype.resetTask=function(){this.answered=false;this.hideEvaluation();this.hideSolutions();this.clearAnswers();this.removeMarkedResults();this.toggleButtonVisibility(STATE_ONGOING);this.resetGrowTextField();this.toggleAllInputs(true);this.done=false;};Blanks.prototype.hideButtons=function(){this.toggleButtonVisibility(STATE_FINISHED);};Blanks.prototype.triggerAnswered=function(){this.answered=true;var xAPIEvent=this.createXAPIEventTemplate('answered');this.addQuestionToXAPI(xAPIEvent);this.addResponseToXAPI(xAPIEvent);this.trigger(xAPIEvent);};Blanks.prototype.getXAPIData=function(){var xAPIEvent=this.createXAPIEventTemplate('answered');this.addQuestionToXAPI(xAPIEvent);this.addResponseToXAPI(xAPIEvent);return{statement:xAPIEvent.data.statement};};Blanks.prototype.getxAPIDefinition=function(){var definition={};definition.description={'en-US':this.params.text};definition.type='http://adlnet.gov/expapi/activities/cmi.interaction';definition.interactionType='fill-in';const clozeSolutions=[];let crp='';for(var i=0;i<this.params.questions.length;i++){var question=this.handleBlanks(this.params.questions[i],function(solution){clozeSolutions.push(solution.solutions);crp+=(!crp?'':'[,]')+solution.solutions[0];return '__________';});definition.description['en-US']+=question;}
definition.correctResponsesPattern=['{case_matters='+this.params.behaviour.caseSensitive+'}'+crp,];definition.extensions=definition.extensions||{};definition.extensions[XAPI_CASE_SENSITIVITY]=this.params.behaviour.caseSensitive;definition.extensions[XAPI_ALTERNATIVE_EXTENSION]=clozeSolutions;return definition;};Blanks.prototype.addQuestionToXAPI=function(xAPIEvent){var definition=xAPIEvent.getVerifiedStatementValue(['object','definition']);$.extend(true,definition,this.getxAPIDefinition());if(this.hasAlternatives){const context=xAPIEvent.getVerifiedStatementValue(['context']);context.extensions=context.extensions||{};context.extensions[XAPI_REPORTING_VERSION_EXTENSION]='1.1.0';}};Blanks.prototype.parseSolution=function(solutionText){var tip,solution;var tipStart=solutionText.indexOf(':');if(tipStart!==-1){tip=solutionText.slice(tipStart+1);solution=solutionText.slice(0,tipStart);}
else{solution=solutionText;}
var solutions=solution.split('/');this.hasAlternatives=this.hasAlternatives||solutions.length>1;for(var i=0;i<solutions.length;i++){solutions[i]=H5P.trim(solutions[i]);var elem=document.createElement('textarea');elem.innerHTML=solutions[i];solutions[i]=elem.value;}
return{tip:tip,solutions:solutions};};Blanks.prototype.addResponseToXAPI=function(xAPIEvent){xAPIEvent.setScoredResult(this.getScore(),this.getMaxScore(),this);xAPIEvent.data.statement.result.response=this.getxAPIResponse();};Blanks.prototype.getxAPIResponse=function(){var usersAnswers=this.getCurrentState();return usersAnswers.join('[,]');};Blanks.prototype.showEvaluation=function(){var maxScore=this.getMaxScore();var score=this.getScore();var scoreText=H5P.Question.determineOverallFeedback(this.params.overallFeedback,score/maxScore).replace('@score',score).replace('@total',maxScore);this.setFeedback(scoreText,score,maxScore,this.params.scoreBarLabel);if(score===maxScore){this.toggleButtonVisibility(STATE_FINISHED);}};Blanks.prototype.hideEvaluation=function(){this.removeFeedback();};Blanks.prototype.hideSolutions=function(){this.$questions.find('.h5p-correct-answer').remove();};Blanks.prototype.getMaxScore=function(){var self=this;return self.clozes.length;};Blanks.prototype.getScore=function(){var self=this;var correct=0;for(var i=0;i<self.clozes.length;i++){if(self.clozes[i].correct()){correct++;}
self.params.userAnswers[i]=self.clozes[i].getUserAnswer();}
return correct;};Blanks.prototype.getTitle=function(){return H5P.createTitle((this.contentData.metadata&&this.contentData.metadata.title)?this.contentData.metadata.title:'Fill In');};Blanks.prototype.clearAnswers=function(){this.clozes.forEach(function(cloze){cloze.setUserInput('');cloze.resetAriaLabel();});};Blanks.prototype.getAnswerGiven=function(){return this.answered||!this.hasClozes;};Blanks.setFocus=function($input){setTimeout(function(){$input.focus();},1);};Blanks.prototype.getCurrentState=function(){var clozesContent=[];this.clozes.forEach(function(cloze){clozesContent.push(cloze.getUserInput());});return clozesContent;};Blanks.prototype.setH5PUserState=function(){var self=this;var isValidState=(this.previousState!==undefined&&this.previousState.length&&this.previousState.length===this.clozes.length);if(!isValidState){return;}
var hasAllClozesFilled=true;this.previousState.forEach(function(clozeContent,ccIndex){if(clozeContent.length){self.answered=true;}
var cloze=self.clozes[ccIndex];cloze.setUserInput(clozeContent);if(self.params.behaviour.autoCheck){if(cloze.filledOut()){cloze.checkAnswer();}
else{hasAllClozesFilled=false;}}});if(self.params.behaviour.autoCheck&&hasAllClozesFilled){self.showEvaluation();self.toggleButtonVisibility(STATE_CHECKING);}};Blanks.prototype.disableInput=function(){this.$questions.find('input').attr('disabled',true);};Blanks.idCounter=0;return Blanks;})(H5P.jQuery,H5P.Question);