(function($,Blanks){Blanks.Cloze=function(solution,behaviour,defaultUserAnswer,l10n){var self=this;var $input,$wrapper;var answers=solution.solutions;var answer=answers.join('/');var tip=solution.tip;var checkedAnswer=null;var inputLabel=l10n.inputLabel;if(behaviour.caseSensitive!==true){for(var i=0;i<answers.length;i++){answers[i]=answers[i].toLowerCase();}}
var correct=function(answered){if(behaviour.caseSensitive!==true){answered=answered.toLowerCase();}
for(var i=0;i<answers.length;i++){if(behaviour.acceptSpellingErrors===true){var levenshtein=H5P.TextUtilities.computeLevenshteinDistance(answered,answers[i],true);if((answers[i].length>9)&&(levenshtein<=2)){return true;}else if((answers[i].length>3)&&(levenshtein<=1)){return true;}}
if(answered===answers[i]){return true;}}
return false;};this.filledOut=function(){var answered=this.getUserAnswer();return(answered!==''||correct(answered));};this.checkAnswer=function(){checkedAnswer=this.getUserAnswer();var isCorrect=correct(checkedAnswer);if(isCorrect){$wrapper.addClass('h5p-correct');$input.attr('disabled',true).attr('aria-label',inputLabel+'. '+l10n.answeredCorrectly);}
else{$wrapper.addClass('h5p-wrong');$input.attr('aria-label',inputLabel+'. '+l10n.answeredIncorrectly);}};this.disableInput=function(){this.toggleInput(false);};this.enableInput=function(){this.toggleInput(true);};this.toggleInput=function(enabled){$input.attr('disabled',!enabled);};this.showSolution=function(){if(correct(this.getUserAnswer())){return;}
$('<span>',{'aria-hidden':true,'class':'h5p-correct-answer',text:answer,insertAfter:$wrapper});$input.attr('disabled',true);var ariaLabel=inputLabel+'. '+
l10n.solutionLabel+' '+answer+'. '+
l10n.answeredIncorrectly;$input.attr('aria-label',ariaLabel);};this.correct=function(){return correct(this.getUserAnswer());};this.setInput=function($element,afterCheck,afterFocus,clozeIndex,totalCloze){$input=$element;$wrapper=$element.parent();inputLabel=inputLabel.replace('@num',(clozeIndex+1)).replace('@total',totalCloze);if(tip!==undefined&&tip.trim().length>0){$wrapper.addClass('has-tip').append(H5P.JoubelUI.createTip(tip,{tipLabel:l10n.tipLabel}));inputLabel+='. '+l10n.inputHasTipLabel;}
$input.attr('aria-label',inputLabel);if(afterCheck!==undefined){$input.blur(function(){if(self.filledOut()){if(!behaviour.enableRetry){self.disableInput();}
self.checkAnswer();afterCheck.apply(self);}});}
$input.keyup(function(){if(checkedAnswer!==null&&checkedAnswer!==self.getUserAnswer()){checkedAnswer=null;$wrapper.removeClass('h5p-wrong');$input.attr('aria-label',inputLabel);if(afterFocus!==undefined){afterFocus();}}});};this.toString=function(){var extra=defaultUserAnswer?' value="'+defaultUserAnswer+'"':'';var result='<span class="h5p-input-wrapper"><input type="text" class="h5p-text-input" autocomplete="off" autocapitalize="off" spellcheck="false"'+extra+'></span>';self.length=result.length;return result;};this.getUserAnswer=function(){return H5P.trim($input.val());};this.getUserInput=function(){return $input.val();};this.setUserInput=function(text){$input.val(text);};this.resetAriaLabel=function(){$input.attr('aria-label',inputLabel);};};})(H5P.jQuery,H5P.Blanks);